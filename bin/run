#!/usr/bin/env bash

MYDIR=$(readlink -f $(dirname $0))
MYBASE=$(readlink -f $MYDIR/..)

filter_files() {
  grep -v '\.zip$' | grep -v '/level2/' | grep -v 'map_info.txt'
}

find_cache_and_lookup_base_directory() {
  if [[ ! -f $MYBASE/tmp/filedb.txt || -n $RESET  ]]; then
    find /hiidata/teddy/data/jinfiniti/gene_expression -type f | filter_files | sort > $MYBASE/tmp/filedb.txt
  fi
}

find_vial_candidates() {
  grep '\.txt$' $MYBASE/tmp/filedb.txt | awk -F/ '{print $NF}' | sed 's/\(.*\)_[A-Z]\.txt$/\1/' | sort -u
}

find_vial_instances() {
  for c in $( find_vial_candidates ); do
    count=$( grep "/${c}_[A-Z]\.txt" $MYBASE/tmp/filedb.txt  | wc -l )
    echo $c:$count
  done
}

get_sample_txt_files() {
  find $BASEDIR -type f -name '*.txt'
}

#------------------------------------------------------------------------
# main
#------------------------------------------------------------------------

if [[ $1 == '-r' ]]; then
  RESET='y'
  shift
fi

find_cache_and_lookup_base_directory

#find_vial_candidates

find_vial_instances


#get_sample_txt_files
#bundles="201505"
#
#for bundle in $bundles; do
#  find $basedir/$bundle -type f | grep -v '\.zip'  | awk -F'/' '{print $NF}'
#done

# 3998787099_B_Grn.locs
