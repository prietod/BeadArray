#!/usr/bin/env bash

usage() {
  echo "Usage: $( basename $0 ) <code> [chip_barcode] [chip_barcode..]" 1>&2
  exit 1
}

filter_excluded() {
  grep -v '/level2' | grep -v '7911755025' | grep -v '\.zip$'
}

setup_barcode_dirs() {
  local chip_barcode=$1
  work_dir=$WORK_DIR/${chip_barcode}

  work_raw_data_dir=${work_dir}/raw/data

  work_raw_qc_dir=${work_dir}/raw/qc/${code_short_name}

  for d in $work_raw_data_dir $work_raw_qc_dir; do
    mkdir -p $d
  done
}

MYDIR="$( readlink -f $( dirname $0 ))"
MYBASE="$( readlink -f $MYDIR/.. )"

source $MYBASE/lib/env.sh
source $MYBASE/lib/common.sh

[[ $# < 1 ]] && usage

code=${1}; shift

code_short_name=$( basename $code .R )

#chip_barcodes="${@:-3998787078}" # set default for testing

chip_barcodes="${@:-3998755068}" # set default for testing

module load apps/R/${R_VERSION:-3.2.3}

for chip_barcode in ${chip_barcodes}; do

  setup_barcode_dirs ${chip_barcode}

  for f in $( find $DATA_DIR -type f -name "${chip_barcode}*" | filter_excluded ); do
     [[ -f ${work_raw_data_dir}/$( basename $f ) ]] || cp -v $f ${work_raw_data_dir}
   done

  R --slave --quiet --no-restore --no-save \
    --args ${work_raw_data_dir} ${work_raw_qc_dir} < ${code}
done

