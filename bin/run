#!/usr/bin/env bash
#
# https://google.github.io/styleguide/Rguide.xml

filter_excluded() {
  grep -v '/level2' \
  | grep -v '7911755025'
}

setup_barcode_dirs() {
  local chip_barcode=$1
  work_dir=$HII_WORK_DIR/${chip_barcode}

  work_data_dir=${work_dir}/data
  work_qc_dir=${work_dir}/qc
  work_results_dir=${work_dir}/results

  for d in $work_data_dir $work_qc_dir $work_results_dir; do
    mkdir -p $d
  done
}

#set -x

MYDIR=$(readlink -f $(dirname $0))
MYBASE=$(readlink -f $MYDIR/..)

HII_DATA_DIR=${HII_DATA_DIR:-/hiidata}
HII_WORK_DIR=${HII_WORK_DIR:-$MYBASE/tmp}
HII_CODE=${HII_CODE:-$MYBASE/code/BeadArray.R}

CHIP_BARCODES="${@:-3998755068 }" # also 3998787078

module load apps/R/${R_VERSION:-3.2.3}

for chip_barcode in ${CHIP_BARCODES}; do

  setup_barcode_dirs ${chip_barcode}

  find $HII_DATA_DIR/teddy/data/jinfiniti/gene_expression/ -type f -name "${chip_barcode}_[A-L].txt" \
    | filter_excluded \
    | xargs -r -n1 -I% echo cp % ${work_data_dir} | bash -x

  R --slave --quiet --no-restore --no-save \
    --args ${work_data_dir} ${work_qc_dir} ${work_results_dir} < ${HII_CODE}
done

