#!/usr/bin/env bash

BASE="$(readlink -f $(readlink -f $(dirname "${BASH_SOURCE}")/..))"

#---------------------------------------------------------------
# Main
#---------------------------------------------------------------

usage() {
  echo "Usage: $(basename $BASH_SOURCE) <barcode> <script>" 1>&2
  exit 1
}

[[ $# -ne 2 ]] && usage

chip_barcode=$1; shift
script=$1; shift

script_short=$(basename ${script})

DATA_DIR=${DATA_DIR:-$BASE/tmp/data/filtered}
WORK_DIR=${WORK_DIR:-$BASE/tmp/work/${script_short}}

complete_dir=$WORK_DIR/complete
failed_dir=$WORK_DIR/failed

data_dir=$DATA_DIR/${chip_barcode}
results_dir=$WORK_DIR/chip/${chip_barcode}/results

[[ -d ${results_dir} ]] && rm -rf ${results_dir}
[[ -f ${complete_dir}/${chip_barcode}.txt ]] && rm ${complete_dir}/${chip_barcode}.txt
[[ -f ${failed_dir}/${chip_barcode}.txt ]] && rm ${failed_dir}/${chip_barcode}.txt

for dir in ${complete_dir} ${failed_dir} ${results_dir}; do
  mkdir -p ${dir}
done

$BASE/bin/run-R ${script} ${data_dir} ${results_dir}

rc=$?

if [[ $rc == 0 ]]; then
  echo "Completed successfully at $(date +%FT%T)" > ${complete_dir}/${chip_barcode}.txt
  echo "Completed successfully at $(date +%FT%T)"
else
  echo "Failed with return code: $rc" > ${complete_dir}/${chip_barcode}.txt
  echo "Failed with return code: $rc" 1>&2
fi

exit $rc
