#!/usr/bin/env python
#----------------------------------------------------------------------------------------------
#
# Usage: ./bin/util/transform-cols-added <cols_added_file> <map_info_file> <exclude_patterns>
#
# Cycle over all rows in cols_added_file (which contains Donor-Number) and merge in
# donor information and exclude any entries that are in the <exclude_patterns> list.
#
# Outside this script output is generally re-directed to
#   ${WORK_DIR}/common/BeadArray_phenotype_details-<all|donor|non-donor>.txt
#
#----------------------------------------------------------------------------------------------

from pprint import pprint
import fileinput
import sys

header = []
rows = []

cols_added_file = sys.argv[1]
map_info_file = sys.argv[2]
exclude_file = sys.argv[3]

excluded_fields = [ 'draw_dte', 'Date_Received_Sample', 'Date_of_Evaluation' ]

excluded_array_ids = []

map_info_data = {}

with open(map_info_file) as f:
    map_info_header = f.readline()
    for line in f.readlines():
        map_info_columns = line.rstrip('\n').split('\t')
        donor_number = map_info_columns[3]
        array_id = map_info_columns[6] + '_' + map_info_columns[7]
        if donor_number != '' and donor_number != 'NA':
            map_info_data[array_id] = donor_number.replace(' ', '-') # remove spaces as R does not like them in read.table()

with open(exclude_file) as f:
    for line in f.readlines():
      excluded_array_ids.append(line.rstrip('\n'))

with open(cols_added_file) as f:

    # header
    line = f.readline()
    columns = line.rstrip('\n').split('\t')
    header = [ col for col in columns if col not in excluded_fields ]
    header.insert(0,'Array_ID')

    # rows
    for line in f.readlines():
        (subject_id,
        vial_barcode_number,
        test_name,
        donor_number,
        box,
        row,
        chip_barcode,
        array,
        draw_dte,
        sample_status,
        date_received_sample,
        date_of_evaluation,
        comments,
        casestatus,
        sex,
        age_in_months ) = line.rstrip('\n').split('\t')

        array_id = chip_barcode + '_' + array

        if map_info_data.get(array_id):
            donor_number = map_info_data[array_id]

        columns = [ array_id,
                    subject_id, vial_barcode_number, test_name, donor_number,
                    box, row, chip_barcode, array, sample_status, comments,
                    casestatus, sex, age_in_months ]

        columns = [col if col != '' else 'NA' for col in columns]

        rows.append(columns)

print('\t'.join(header))

for row in rows:
  if row[0] not in excluded_array_ids:
     print('\t'.join(row))
