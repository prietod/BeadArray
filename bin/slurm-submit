#!/usr/bin/env bash

MYDIR="$( readlink -f $( dirname $0 ))"
MYBASE="$( readlink -f $MYDIR/.. )"

source $MYBASE/lib/env.sh
source $MYBASE/lib/common.sh

datestamp=$( date +%Y-%m-%dT%H:%M )

code=$1; shift

code_short_name=$( basename $code .R )

log_dir=$MYBASE/tmp/log/${code_short_name}

( mkdir -p $log_dir && cd $log_dir && mkdir $datestamp && ln -nsf $datestamp current )

declare -a ARRAY_MAP
export ARRAY_MAP

while read f; do
  ARRAY_MAP[$((++n))]=$f
done

count=${#ARRAY_MAP[@]}

SUBMIT_CPUS_PER_TASK="${SUBMIT_CPUS_PER_TASK:-2}"
SUBMIT_MEM_MB="${SUBMIT_MEM_MB:-16000}"
SUBMIT_TIME="${SUBMIT_TIME:-16:00:00}"
SUBMIT_PARTITION="hii02"

set -x

sbatch \
  --ntasks=1 \
  --job-name="${code_short_name}" \
  --output=${log_dir}/${datestamp}/%a.log \
  --array=1-${count} \
  --mem=${SUBMIT_MEM_MB} \
  --cpus-per-task=${SUBMIT_CPUS_PER_TASK} \
  --time=${SUBMIT_TIME} \
  --partition=${SUBMIT_PARTITION} \
  --wrap="$MYBASE/bin/random-sleep; $MYBASE/bin/run $code \${ARRAY_MAP[\$SLURM_ARRAY_TASK_ID]}"
